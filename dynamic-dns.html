<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dynamic DNS | Joseph Choe</title>
    <meta name="description" content="I think about software development, writing, and many other things." />

        <link rel="alternate" type="application/atom+xml" title="Joseph Choe" href="/feed.xml">
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">

    <meta name="author" content="Joseph Choe" />

  <meta property="og:url" content="https://josephchoe.com/dynamic-dns" />
  <meta property="og:title" content="Dynamic DNS | Joseph Choe" />
  <meta property="og:description" content="I’ve been self-hosting some services on my homelab. However, since I don’t have a static IP through my Internet service provider, I need some sort of dynamic DNS script that will update the requisi..." />
  <meta property="og:image" content="https://josephchoe.com/assets/images/zurrey.jpg" />


  <meta property="og:type" content="article" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@josephchoe" />
  <meta name="twitter:creator" content="@josephchoe" />
  <meta name="twitter:title" content="Dynamic DNS | Joseph Choe" />
  <meta name="twitter:description" content="I’ve been self-hosting some services on my homelab. However, since I don’t have a static IP through my Internet service provider, I need some sort of dynamic DNS script that will update the requisi..." />

  <meta name="twitter:image" content="https://josephchoe.com/assets/images/zurrey.jpg" />


  </head>

  <body>
    <header>
      <h1><a href="/" title="Joseph Choe">Joseph Choe</a></h1>
    </header>

    <main id="content">
      


<article>
  <div class="parent">
    <a href="/essay" rel="tag">Essays</a>
  </div>
  <div class="title">
    <h1>Dynamic DNS</h1>
  </div>
  <div class="post-date">
    <small>Fri Dec 17 2021</small>
  </div>
  <p>I’ve been self-hosting some services on my <a href="/infrastructure">homelab</a>. However, since I don’t have a static IP through my Internet service provider, I need some sort of dynamic DNS script that will update the requisite A record on my name server.</p>

<p>Here’s how I do it.</p>

<h2 id="server-configuration">Server Configuration</h2>

<p>Provision a <a href="/openbsd-proxmox">new virtual machine</a> with OpenBSD 7.0 installed, <a href="/openntpd">setup NTP</a>, all of that stuff.</p>

<p>Ruby is a great scripting language, with a clean, easy to understand syntax. Therefore, I need to install Ruby onto the machine, which I’ve <a href="/compiling-ruby-from-source">gone over before</a>.</p>

<p>I also installed <a href="https://github.com/postmodern/chruby"><code class="language-plaintext highlighter-rouge">chruby</code></a>, a pair of shell scripts that set environment variables like <code class="language-plaintext highlighter-rouge">PATH</code> and <code class="language-plaintext highlighter-rouge">RUBIES</code> so that the system knows where to find the installed Ruby. However, it has a dependency on <code class="language-plaintext highlighter-rouge">bash</code>, so be aware of that.</p>

<p>I’d like to port <code class="language-plaintext highlighter-rouge">chruby</code> to <code class="language-plaintext highlighter-rouge">ksh</code>, or KornShell, but I haven’t had the time yet. Maybe one of these days!</p>

<h2 id="script">Script</h2>

<p>I use AWS Route 53 at the moment, mostly because it has an API I’m familiar with, but also because I haven’t found anything better that suits my needs.</p>

<p>The below script queries an IP lookup URL and compares that value with the A record in Route 53. If they match, then the script exits early. Otherwise, it sends an upsert changeset to AWS.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'net/http'</span>

<span class="nb">require</span> <span class="s1">'oga'</span>
<span class="nb">require</span> <span class="s1">'aws-sdk-route53'</span>

<span class="n">hosted_zone_id</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"ZONE_ID"</span><span class="p">]</span>
<span class="n">dns_name</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"DNS_NAME"</span><span class="p">]</span>
<span class="n">ip_lookup_uri</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"IP_LOOKUP_URI"</span><span class="p">]</span>

<span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="n">ip_lookup_uri</span><span class="p">)</span>
<span class="n">current_ip</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Aws</span><span class="o">::</span><span class="no">Route53</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">list_resource_record_sets</span><span class="p">({</span>
  <span class="ss">:hosted_zone_id</span> <span class="o">=&gt;</span> <span class="n">hosted_zone_id</span><span class="p">,</span>
  <span class="ss">:start_record_name</span> <span class="o">=&gt;</span> <span class="n">dns_name</span><span class="p">,</span>
  <span class="ss">:start_record_type</span> <span class="o">=&gt;</span> <span class="s2">"A"</span><span class="p">,</span>
  <span class="ss">:max_items</span> <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="p">})</span>

<span class="n">record_set</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">resource_record_sets</span><span class="p">.</span><span class="nf">first</span>
<span class="n">resource_record</span> <span class="o">=</span> <span class="n">record_set</span><span class="p">.</span><span class="nf">resource_records</span><span class="p">.</span><span class="nf">first</span>
<span class="n">previous_ip</span> <span class="o">=</span> <span class="n">resource_record</span><span class="p">.</span><span class="nf">value</span>

<span class="k">if</span> <span class="n">current_ip</span> <span class="o">==</span> <span class="n">previous_ip</span>
  <span class="nb">exit</span> <span class="mi">0</span>
<span class="k">end</span>

<span class="n">client</span><span class="p">.</span><span class="nf">change_resource_record_sets</span><span class="p">({</span>
  <span class="ss">:change_batch</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:changes</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">"UPSERT"</span><span class="p">,</span>
        <span class="ss">:resource_record_set</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">dns_name</span><span class="p">,</span>
          <span class="ss">:resource_records</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="n">current_ip</span>
            <span class="p">},</span>
          <span class="p">],</span>
          <span class="ss">:ttl</span> <span class="o">=&gt;</span> <span class="mi">900</span><span class="p">,</span>
          <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">"A"</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">],</span>
  <span class="p">},</span>
  <span class="ss">:hosted_zone_id</span> <span class="o">=&gt;</span> <span class="n">hosted_zone_id</span>
<span class="p">})</span>

<span class="nb">exit</span> <span class="mi">0</span>
</code></pre></div></div>

<p>The only third party dependencies I’m using are to the AWS Ruby Route 53 SDK and <code class="language-plaintext highlighter-rouge">oga</code>, which is itself a dependency of the SDK. Other than that, I’m using <code class="language-plaintext highlighter-rouge">net/http</code> which is part of the Ruby Standard Library, rather than use one of the many HTTP gems out there.</p>

<p>You should always keep dependencies down to the bare minimum. I could have used one of the many, <em>many</em> HTTP Ruby libraries, but I’m often more focused on future stability than using the hottest new thing. I can rely on the <code class="language-plaintext highlighter-rouge">net/http</code> library to be stable far more than I can one of HTTP Ruby libraries, if I’m honest.</p>

<p>Because I’m using environment variables, I need to export those in a separate shell script:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>...
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>...
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>...
<span class="nb">export </span><span class="nv">ZONE_ID</span><span class="o">=</span>...
<span class="nb">export </span><span class="nv">DNS_NAME</span><span class="o">=</span>example.com
<span class="nb">export </span><span class="nv">IP_LOOKUP_URI</span><span class="o">=</span>https://api.example.org
</code></pre></div></div>

<p>Use whatever IP lookup service makes sense for you, though I use my own self-hosted one.</p>

<p>I wrote a script to source things like <code class="language-plaintext highlighter-rouge">chruby</code> and the requisite environment variables and then run the Ruby script itself.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">HOME</span><span class="o">=</span>/home/joseph

<span class="nb">source</span> <span class="nv">$HOME</span>/.bashrc

<span class="nb">source</span> <span class="nv">$HOME</span>/dynamic-dns/env.sh

ruby <span class="nv">$HOME</span>/dynamic-dns/dynamic_dns.rb
</code></pre></div></div>

<p>Finally, I setup a cronjob to execute the script every fifteen minutes.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>/15 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /home/joseph/bin/dynamic-dns.sh
</code></pre></div></div>

<p>I can also call the script manually if I want.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This setup is a bit more finicky than I would like. I’d like to move away from <code class="language-plaintext highlighter-rouge">bash</code> at some point, for example, and adding one more dependency to it means one more thing to change when I eventually do.</p>

<p>Still, it works, and while that’s not the greatest factor in determining whether to deploy something, it is <em>a</em> factor.</p>

  <footer>
    <hr />
    
<div class="page-navigation">

  <a class="previous" href="/loyalty">&laquo; Company Loyalty</a>


|


  <a class="next" href="/opensmtpd-local-network">OpenSMTPD on the Local Network &raquo;</a>

</div>


    <div class="no-comments">
  <a href="/no-comments">No comments.</a>
</div>

    <div class="copyright">
  &copy; 2021 <a href="https://josephchoe.com">Joseph Choe</a>.
</div>

  </footer>
</article>

    </main>

    <footer>
    </footer>
  </body>
</html>
