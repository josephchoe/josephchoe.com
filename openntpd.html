<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Provisioning an NTP Server | Joseph Choe</title>
    <meta name="description" content="I think about software development, writing, and many other things." />

        <link rel="alternate" type="application/atom+xml" title="Joseph Choe" href="/feed.xml">
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">

    <meta name="author" content="Joseph Choe" />

  <meta property="og:url" content="https://josephchoe.com/openntpd" />
  <meta property="og:title" content="Provisioning an NTP Server | Joseph Choe" />
  <meta property="og:description" content="One of the first things I did upon receiving my new Framework laptop was to provision a personal NTP server." />
  <meta property="og:image" content="https://josephchoe.com/assets/images/zurrey.jpg" />


  <meta property="og:type" content="article" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@josephchoe" />
  <meta name="twitter:creator" content="@josephchoe" />
  <meta name="twitter:title" content="Provisioning an NTP Server | Joseph Choe" />
  <meta name="twitter:description" content="One of the first things I did upon receiving my new Framework laptop was to provision a personal NTP server." />

  <meta name="twitter:image" content="https://josephchoe.com/assets/images/zurrey.jpg" />


  </head>

  <body>
    <header>
      <h1><a href="/" title="Joseph Choe">Joseph Choe</a></h1>
    </header>

    <main id="content">
      


<article>
  <div class="parent">
    <a href="/essay" rel="tag">Essays</a>
  </div>
  <div class="title">
    <h1>Provisioning an NTP Server</h1>
  </div>
  <div class="post-date">
    <small>Fri Nov 5 2021</small>
  </div>
  <p>One of the first things I did upon receiving my new <a href="/framework">Framework laptop</a> was to provision a personal NTP server.</p>

<p>The Network Time Protocol allows for networked systems to synchronize their clocks between themselves. However, I would rather <em>not</em> have my devices connect to Google or Cloudflare, so instead I decided to provision an NTP server on my home network and have my machines connect to that.</p>

<h2 id="virtual-machine">Virtual Machine</h2>

<p>First, I provisioned a <a href="/openbsd-proxmox">new virtual machine</a> with OpenBSD 7.0 installed.</p>

<p>Then, I configured <code class="language-plaintext highlighter-rouge">/etc/ntpd.conf</code> to connect to the servers I wanted:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listen</span> <span class="n">on</span> <span class="m">10</span>.<span class="m">10</span>.<span class="m">10</span>.<span class="m">10</span>

<span class="n">servers</span> <span class="n">pool</span>.<span class="n">ntp</span>.<span class="n">example</span>.<span class="n">org</span>
<span class="n">sensor</span> *

<span class="n">constraint</span> <span class="n">from</span> <span class="s2">"https://example.com"</span>
<span class="n">constraint</span> <span class="n">from</span> <span class="s2">"https://example.org"</span>
</code></pre></div></div>

<p>The constraint directive checks the HTTP <code class="language-plaintext highlighter-rouge">Date</code> header of the websites in question, so be sure to use a reliable one.</p>

<p>Make sure the <code class="language-plaintext highlighter-rouge">listen</code> keyword is there or your server won’t be listening for any requests from your other machines.</p>

<p>We also need to configure the server’s packet filter configuration, or <code class="language-plaintext highlighter-rouge">/etc/pf.conf</code>:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">if</span> = <span class="s2">"vio0"</span>
<span class="n">set</span> <span class="n">skip</span> <span class="n">on</span> <span class="n">lo</span>
<span class="n">block</span> <span class="n">return</span>
<span class="n">pass</span> <span class="n">in</span> <span class="n">on</span> $<span class="n">if</span> <span class="n">inet</span> <span class="n">proto</span> <span class="n">icmp</span>
<span class="n">pass</span> <span class="n">in</span> <span class="n">on</span> $<span class="n">if</span> <span class="n">inet</span> <span class="n">proto</span> {<span class="n">tcp</span> <span class="n">udp</span>} <span class="n">to</span> <span class="n">port</span> <span class="n">ntp</span>
<span class="n">pass</span> <span class="n">out</span> <span class="n">on</span> $<span class="n">if</span>
</code></pre></div></div>

<p>The first three lines are pretty straightforward, while the fourth line allows me to ping the server. The fifth line allows the <code class="language-plaintext highlighter-rouge">ntp</code> port through, or port 123.</p>

<h2 id="local-dns">Local DNS</h2>

<p>Right now I use <code class="language-plaintext highlighter-rouge">pihole</code> to configure local DNS, though that may change in the future. In any case, I added an entry for <code class="language-plaintext highlighter-rouge">ntp.home.lan</code> to point to the virtual machine’s IP address.</p>

<p>I could simply use the VM’s IP address directly, but I’d rather use something human readable, and this gives me the option of setting something once on all my devices and changing the configuration on the <code class="language-plaintext highlighter-rouge">pihole</code> if the network topology needs to change.</p>

<h2 id="the-framework">The Framework</h2>

<p>All that I need to do now is point my Framework’s <code class="language-plaintext highlighter-rouge">/etc/ntpd.conf</code> file to the local NTP server.</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="n">ntp</span>.<span class="n">home</span>.<span class="n">lan</span>
</code></pre></div></div>

<p>And then restart <a href="https://man.openbsd.org/ntpd"><code class="language-plaintext highlighter-rouge">ntpd(8)</code></a> on the Framework:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rcctl restart ntpd
</code></pre></div></div>

<p>I can check the status of the NTP daemon through <a href="https://man.openbsd.org/ntpctl"><code class="language-plaintext highlighter-rouge">ntpctl(8)</code></a>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ntpctl <span class="nt">-sa</span>
1/1 peers valid, clock synced, stratum 4

peer
   wt tl st  next  poll          offset       delay      jitter
10.10.10.10 ntp.home.lan
 <span class="k">*</span>  1 10  3   28s   33s        <span class="nt">-0</span>.276ms     2.456ms     2.214ms
</code></pre></div></div>

<p>Or I can just <a href="https://man.openbsd.org/tail"><code class="language-plaintext highlighter-rouge">tail(1)</code></a> the logs:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /var/log/daemon
Nov  4 12:44:06 devbox ntpd[75687]: ntp engine ready
Nov  4 12:44:28 devbox ntpd[75687]: peer 10.10.10.10 now valid
Nov  4 12:49:03 devbox ntpd[75687]: clock is now synced
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>I have to say that I love my <a href="/infrastructure">homelab</a>! It allows me to easily provision new servers with a click of a button, and I can have new infrastructure and services easily configured in OpenBSD.</p>

<p>Next I hope to tackle a <code class="language-plaintext highlighter-rouge">git</code> or <code class="language-plaintext highlighter-rouge">smtp</code> server.</p>

  <footer>
    <hr />
    
<div class="page-navigation">

  <a class="previous" href="/openbsd-proxmox">&laquo; Installing OpenBSD on a Proxmox VM</a>


|


  <a class="next" href="/exploring-ruby-cgi">Exploring Ruby CGI &raquo;</a>

</div>


    <div class="no-comments">
  <a href="/no-comments">No comments.</a>
</div>

    <div class="copyright">
  &copy; 2021 <a href="https://josephchoe.com">Joseph Choe</a>.
</div>

  </footer>
</article>

    </main>

    <footer>
    </footer>
  </body>
</html>
